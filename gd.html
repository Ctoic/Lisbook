<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <!-- Favicon -->
    <link rel="icon" href="Images/favicon.jpg" type="image/png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    />
    <title>My Favorite Books Music App</title>
    <style>
        body.embedded #book-details { display: block; }
        body.embedded #other-sections { display: none; }

        /* Chatbot Styles */
        #chatbot { position: fixed; bottom: 20px; right: 20px; width: 320px; background-color: #1e293b; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; z-index: 1000; }
        #chatbot-header { background-color: #16a34a; color: #fff; padding: 12px; cursor: pointer; font-weight: bold; }
        #chatbot-body { display: none; padding: 12px; height: 320px; overflow-y: auto; flex-direction: column; }
        #chatbot-messages { display: flex; flex-direction: column; gap: 6px; max-height: 220px; overflow-y: auto; }
        #chatbot-messages div { padding: 6px 10px; border-radius: 10px; max-width: 80%; }
        #chatbot-messages div.user { background-color: #2563eb; color: white; align-self: flex-end; }
        #chatbot-messages div.bot { background-color: #334155; color: white; align-self: flex-start; }
        #chatbot-input { width: 100%; padding: 8px; border-radius: 8px; border: none; outline: none; }
        .chatbot-option { background-color: #374151; color: #86efac; padding: 4px 8px; border-radius: 8px; cursor: pointer; margin-right: 4px; margin-top: 4px; display: inline-block; }
        .chatbot-option:hover { background-color: #4b5563; }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 d-flex flex-column min-h-screen">
<script>
    (function() {
        try {
            const saved = localStorage.getItem('theme');
            const theme = saved === 'light' ? 'light' : (saved === 'dark' ? 'dark' : null);
            if (theme) {
                document.documentElement.setAttribute('data-theme', theme);
                document.body.classList.remove('light-theme', 'dark-theme');
                document.body.classList.add(theme + '-theme');
            }
        } catch (e) { console.warn('iframe theme init error', e); }
    })();
</script>

<main class="container flex-col">
    <div id="book-details">
        <!-- Book Card Display -->
        <section class="row flex-col md:flex-row align-items-stretch rounded-5 p-5">
            <div class="col-12 col-lg-4 mb-5 mb-lg-0">
                <div class="features-card border rounded-5 p-4 text-center h-100">
                    <!-- Cover Image -->
                    <div class="card-cover-container rounded-4 d-flex align-items-center border" style="height: 16rem">
                        <img id="img" src="./Images/GD.jpeg" alt="God Delusion Cover" class="card-img-top img-fluid" />
                    </div>
                    <!-- Book Details -->
                    <div class="mt-4" data-book="godDelusion">
                        <h1 class="text-2xl font-bold text-green-500" data-translate="title">
                            God Delusion
                        </h1>
                        <h3 class="text-lg mt-2" data-translate="author">By Richard Dawkins</h3>
                        <p class="text-sm mt-2" data-translate="description">
                            The God Delusion is a book by English biologist Richard Dawkins that argues against the existence of a supernatural creator.
                        </p>
                    </div>

                    <hr class="opacity-50 w-auto mt-4 mx-auto" />

                    <!-- Favorite, share, comment Buttons -->
                    <div class="mt-3 flex justify-center icon-action-btn-container">
                        <i class="bi bi-heart mx-4 icon-action-btn tooltip-parent tooltip-bottom" id="favourite-btn">
                            <span class="tooltip" id="favourite">Save to Favourites</span>
                        </i>
                        <i class="bi bi-share mx-4 icon-action-btn tooltip-parent tooltip-bottom" id="share-btn" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">
                            <span class="tooltip" id="share">Share</span>
                        </i>
                        <i class="bi bi-chat mx-4 icon-action-btn tooltip-parent tooltip-bottom" id="view-comments-btn">
                            <span class="tooltip" id="view">View comments</span>
                        </i>
                    </div>
                </div>
            </div>
            <!-- Playlist -->
            <div class="col-12 col-lg-8 ps-4" data-book="godDelusion">
                <div class="features-card border rounded-5 p-4 text-center h-100">
                    <ul id="playlist" class="playlist list-none text-left overflow-auto m-2 mb-4">
                        <!-- Tracks List -->
                        <li class="adiobk-sub-item d-flex justify-content-between flex-column" data-src="audio/part1.mp3">
                            <div class="d-flex justify-content-between">
                                <p data-translate="t0">Introduction: God Delusion</p>
                                <a href="audio/part1.mp3" download><i class="bi bi-cloud-arrow-down-fill"></i></a>
                            </div>
                            <div class="bg-gray-700 flex-1 rounded-full ring-1">
                                <div class="progress-bar bg-red bg-white rounded-full"></div>
                            </div>
                        </li>
                        <!-- Add remaining tracks here -->
                    </ul>

                    <!-- Audio Player -->
                    <div class="player container rounded-5">
                        <audio id="audio-player" class="mt-4 mx-auto"></audio>
                        <span id="currentTime">0:00</span>
                        <input type="range" id="seekSlider" min="0" value="0" />
                        <span id="duration">0:00</span>
                        <div class="relative inline-block">
                            <span id="speedButton" class="cursor-pointer text-green-300 font-semibold rounded-lg py-1 px-3 hover:text-green-200 transition">1x</span>
                            <ul id="speedDropdown" class="absolute hidden bg-gray-800 shadow-md rounded-xl mt-2 w-20">
                                <li class="px-4 py-2 cursor-pointer hover:bg-gray-700 rounded-xl text-green-300" data-speed="0.5">0.5x</li>
                                <li class="px-4 py-2 cursor-pointer hover:bg-gray-700 rounded-xl text-green-300" data-speed="1">1x</li>
                                <li class="px-4 py-2 cursor-pointer hover:bg-gray-700 rounded-xl text-green-300" data-speed="1.5">1.5x</li>
                                <li class="px-4 py-2 cursor-pointer hover:bg-gray-700 rounded-xl text-green-300" data-speed="2">2x</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Audio Player Controls -->
                    <div class="ctrl-player mt-4" id="ctrl-player">
                        <div class="ctrl-buttons d-flex justify-content-evenly align-items-center">
                            <div class="ctrl-button ctrl-button-small" id="volume-down"><i class="bi bi-volume-down-fill"></i></div>
                            <div class="ctrl-button ctrl-button-medium" id="fast-backward"><span>-30</span></div>
                            <div class="ctrl-button ctrl-button-large" id="ctrl-play"><i class="bi bi-play-fill"></i></div>
                            <div class="ctrl-button ctrl-button-medium" id="fast-forward"><span>+30</span></div>
                            <div class="ctrl-button ctrl-button-small" id="volume-up"><i class="bi bi-volume-up-fill"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Chatbot Widget -->
<div id="chatbot">
    <div id="chatbot-header">Chat with Assistant</div>
    <div id="chatbot-body">
        <div id="chatbot-messages"></div>
        <div class="mt-2 flex gap-2">
            <input type="text" id="chatbot-input" placeholder="Type your message..." />
            <button id="chatbot-send">Send</button>
        </div>
        <div class="mt-2">
            <span class="chatbot-option" data-msg="Show book summary">Book Summary</span>
            <span class="chatbot-option" data-msg="Show playlist">Playlist</span>
            <span class="chatbot-option" data-msg="Help me">Help</span>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="./script.js"></script>
<script src="./translation.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Theme and translation sync
    if (window.location !== window.parent.location) document.body.classList.add('embedded');
    window.addEventListener('message', (event) => {
        const data = event.data || {};
        if(data.type==='changeLanguage') applyTranslations(data.language);
        if(data.type==='theme' && (data.theme==='light'||data.theme==='dark')){
            document.documentElement.setAttribute('data-theme', data.theme);
            document.body.classList.remove('light-theme', 'dark-theme');
            document.body.classList.add(data.theme+'-theme');
        }
    });
    document.addEventListener('DOMContentLoaded', function(){ applyTranslations('en'); });

    // Chatbot Logic with Audio Controls
    const chatbotHeader = document.getElementById('chatbot-header');
    const chatbotBody = document.getElementById('chatbot-body');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotOptions = document.querySelectorAll('.chatbot-option');

    const audioPlayer = document.getElementById('audio-player');
    const playlistItems = document.querySelectorAll('#playlist .adiobk-sub-item');
    let currentTrackIndex = 0;

    function loadTrack(index){
        if(index < 0 || index >= playlistItems.length) return;
        currentTrackIndex = index;
        const src = playlistItems[index].getAttribute('data-src');
        audioPlayer.src = src;
        audioPlayer.play();
        addMessage(`Now playing: ${playlistItems[index].querySelector('p').textContent}`);
    }

    function addMessage(text, sender='bot') {
        const msgDiv = document.createElement('div');
        msgDiv.textContent = text;
        msgDiv.classList.add(sender);
        chatbotMessages.appendChild(msgDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function botReply(message) {
        message = message.toLowerCase();
        
        // Play Track Command
        const playMatch = message.match(/play track (\d+)/);
        if(playMatch){
            const trackNum = parseInt(playMatch[1])-1;
            if(trackNum >= 0 && trackNum < playlistItems.length){
                loadTrack(trackNum);
            } else { addMessage("Track number out of range."); }
            return;
        }

        if(message.includes('pause')) { audioPlayer.pause(); addMessage("Playback paused."); return; }
        if(message.includes('resume') || message.includes('play')) { audioPlayer.play(); addMessage("Playback resumed."); return; }
        if(message.includes('next')) { loadTrack(currentTrackIndex+1); return; }
        if(message.includes('previous')) { loadTrack(currentTrackIndex-1); return; }

        const speedMatch = message.match(/speed (\d*\.?\d+)x/);
        if(speedMatch){ audioPlayer.playbackRate = parseFloat(speedMatch[1]); addMessage(`Playback speed set to ${speedMatch[1]}x`); return; }

        if(message.includes('summary')) addMessage("God Delusion by Richard Dawkins is a book arguing against the existence of a supernatural creator.");
        else if(message.includes('playlist')) addMessage("The playlist has multiple tracks. You can play or download each track from the list.");
        else if(message.includes('help')) addMessage("You can type commands like 'Play Track 3', 'Pause', 'Next', 'Previous', 'Speed 1.5x', or ask 'Book Summary'/'Playlist'.");
        else addMessage("Sorry, I didn't understand. Try commands like 'Play Track 3', 'Pause', or 'Book Summary'.");
    }

    // Event listeners
    chatbotHeader.addEventListener('click', () => chatbotBody.style.display = chatbotBody.style.display==='flex'?'none':'flex');
    chatbotSend.addEventListener('click', () => {
        const msg = chatbotInput.value.trim();
        if(!msg) return;
        addMessage(msg, 'user');
        chatbotInput.value='';
        setTimeout(()=>botReply(msg),500);
    });
    chatbotInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') chatbotSend.click(); });
    chatbotOptions.forEach(option => option.addEventListener('click', () => {
        const msg = option.getAttribute('data-msg');
        addMessage(msg,'user'); 
        setTimeout(()=>botReply(msg),500);
    }));
</script>
</body>
</html>
